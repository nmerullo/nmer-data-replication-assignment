---
title: "Mahabala.et.al_AnalysisReplication"
author: "Nicole Merullo"
date: "`r Sys.Date()`"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Dengue Fever, Systolic BP, and Multiple Logistic Regression

```{r mosquito, echo=FALSE, fig.align='center', out.width='100%'}
knitr::include_graphics('https://www.cdc.gov/dengue/images/transmission/Aedes-aegypti.jpg?_=25767') 
```

Dengue fever is a viral disease spread by mosquitoes. 10-15% of cases in humans progress to severe dengue which can result in mortality. Currently, the gold standard for severe dengue diagnosis is a rise in hematocrit. Hematocrit is a biomarker for red blood cell concentration. In severe dengue, fluid leaks from the capillaries causing a sharp increase in red blood cell concentration, measured by hematocrit and a concomitant drop in platelets. However, running these blood tests is expensive for low resource hospitals and may not be informative if a baseline hematocrit is not available. Other parameters for diagnosis for severe dengue, as recognized by World Health Organization (WHO), are abdominal pain, persistent vomiting, fluid accumulation (pleural effusion), muscosal bleeding, lethargy, and liver enlargement. Mahabala et al. (2023) propose a new diagnostic standard as a proxy for capillary leak. Loss of fluid into the interstitial space causes hypovolemia and consequently, hypotension. Orthostatic blood pressure changes (i.e., standing up) can be used instead to assess if a patient has progressed to severe dengue. 

Mahabala et al. conducted a prospective observational study with 150 patients admitted to a hospital with dengue between 2011-2015. 23 of those patients developed severe dengue while in the study by existing WHO parameters. The researchers assessed all WHO recognized parameters of severe dengue along with postural change in systolic blood pressure (SBP) to see if their prediction that a drop in blood pressure while standing up could be used as a proxy for capillary leak experienced during severe dengue. They determined that a 10.33% postural drop in SBP was the ideal cut off between dengue and severe dengue. 

There are two analyses I will replicate. The first is comparing mean parameters between severe dengue and non-severe dengue to determine if these were significantly different distributions. The parameters used in this analysis were age, duration of fever before admission in days, hemoglobin on admission, hematocrit on admission, platelet count on admission, total leukocyte count, aspartate transaminase, lowest platelet, percentage fall in SBP, and albumin. The second is a multiple logistic regression to identify parameters with a statistically significant adjusted odds ration of developing severe dengue. The parameters used in this analysis were rise in hematocrit, ascites/pleural effusion, postural fall in SBP, hepatomegaly, lethargy, persistent vomiting, severe abdominal pain, and mucosal bleeding. I will create an odds ratio plot to visualize this logistic regression.

## Data

First I will import the data supplement from Mahabala et al 2023.

```{r import}
library(curl)
f <- curl("https://raw.githubusercontent.com/nmerullo/nmer-data-replication-assignment/main/Dengue_F1000.csv")
dengue <- read.csv(f, header = TRUE, sep = ",")
head(dengue)
summary(dengue)
```
Notably, the parameters for the multiple regression are mostly entered in as 0s and 1s denoting absence or presence of the condition. These variables will need to be converted to factors for multiple logistic regression.

Below is some exploratory visualization of postual drop in SBP, fall percentage, and the traditional proxy for capillary leak, hematocrit. The data supplement uses PCV (packed cell volume) which is a synonym for hematocrit. People with severe dengue have higher mean postural fall in SBP, percentage of SBP fall, hematocrit at admission, and hematocrit on day 2. Further analysis is needed to see if these are statistically significant differences.

```{r exploratoryvis}
par(mfrow = c(1, 4))
plot(as.factor(dengue$Severe_Dengue), dengue$Postural.SBP_Drop, xlab = "Severe Dengue", ylab = "Systolic BP Drop", col = "steelblue1")
plot(as.factor(dengue$Severe_Dengue), dengue$Fall_Percentage, xlab = "Severe Dengue", ylab = "SBP Fall Percentage", col = "lightgoldenrod")
plot(as.factor(dengue$Severe_Dengue), dengue$PCV_day_1, xlab = "Severe Dengue", ylab = "Hematocrit Day 1", col = "navy")
plot(as.factor(dengue$Severe_Dengue), dengue$PCV_day_2, xlab = "Severe Dengue", ylab = "Hematocrit Day 2", col = "seashell")
```

## Severe vs Non Severe Dengue

It is important to first establish if the severe dengue patients and the non-severe dengue patients are actually two statistically distinct distributions. If they are not, then there is no point in determining diagnostic criteria for severe dengue. To do this, the authors compared means and standard deviations of 10 variables between the two patient groups and derived p values. The paper does not discuss how it got their p values. I will use two sample t tests to compare the two samples (severe vs non severe) for each variable. Below is the table provided by the authors:

```{r table1, echo=FALSE, fig.align='center', out.width='85%'}
knitr::include_graphics('https://github.com/nmerullo/nmer-data-replication-assignment/blob/main/Mahabala-et-al-2023_Table1.png?raw=true') 
```

### Subset Samples

First I am subsetting the data frame down to the severe dengue patients and the non severe dengue patients.

```{r severedengue}
library(dplyr)
severe.dengue <- filter(dengue, Severe_Dengue == 1)
head(severe.dengue) #for fun
length(severe.dengue$Number) #checking that this value equals the number of severe dengue patients reported in the study (23)
```

```{r nonseveredengue}
nonsevere.dengue <- filter(dengue, Severe_Dengue == 0)
head(nonsevere.dengue)
```

### Severe Dengue Descriptive Stats

Next I am calculating the mean and standard deviation for each of the parameters in Table 1 for each population. The data supplement does not include a column for lowest platelet count and does not include how they derived this value for each sample, so I am excluding it for this analysis.

#### Creating objects for each of the variables for severe dengue:

```{r severedenguevariables}
severe.age <- severe.dengue$Age
severe.fever <- severe.dengue$f_adm
severe.hgb <- severe.dengue$Hb_day_1
severe.hct <- severe.dengue$PCV_day_1
severe.platelets <- severe.dengue$Platelet_day_1
severe.leukocytes <- severe.dengue$TLC
severe.ast <- severe.dengue$AST
severe.sbp <- severe.dengue$Fall_Percentage
severe.alb <- severe.dengue$Albumin
```

#### Next up, means for each of these variables:

```{r severedenguemeans}
m.severe.age <- mean(severe.age)
m.severe.fever <- mean(severe.fever)
m.severe.hgb <- mean(severe.hgb)
m.severe.hct <- mean(severe.hct)
m.severe.platelets <- mean(severe.platelets)
m.severe.leukocytes <- mean(severe.leukocytes)
m.severe.ast <- mean(severe.ast)
m.severe.sbp <- mean(severe.sbp)
m.severe.alb <- mean(severe.alb)
```

#### And finally, standard deviations for each of these!

```{r severedengueSDs}
sd.severe.age <- sd(severe.age)
sd.severe.fever <- sd(severe.fever)
sd.severe.hgb <- sd(severe.hgb)
sd.severe.hct <- sd(severe.hct)
sd.severe.platelets <- sd(severe.platelets)
sd.severe.leukocytes <- sd(severe.leukocytes)
sd.severe.ast <- sd(severe.ast)
sd.severe.sbp <- sd(severe.sbp)
sd.severe.alb <- sd(severe.alb)
```

### Non Severe Dengue Descriptive Stats

I will repeat the above for the non severe sample, again excluding lowest platelet count.

#### Creating objects for each of the variables for severe dengue:

```{r nonseveredenguevariables}
nonsevere.age <- nonsevere.dengue$Age
nonsevere.fever <- nonsevere.dengue$f_adm
nonsevere.hgb <- nonsevere.dengue$Hb_day_1
nonsevere.hct <- nonsevere.dengue$PCV_day_1
nonsevere.platelets <- nonsevere.dengue$Platelet_day_1
nonsevere.leukocytes <- nonsevere.dengue$TLC
nonsevere.ast <- nonsevere.dengue$AST
nonsevere.sbp <- nonsevere.dengue$Fall_Percentage
nonsevere.alb <- nonsevere.dengue$Albumin
```

#### Means for non severe dengue variables:

```{r nonseveredenguemeans}
m.nonsevere.age <- mean(nonsevere.age)
m.nonsevere.fever <- mean(nonsevere.fever)
m.nonsevere.hgb <- mean(nonsevere.hgb)
m.nonsevere.hct <- mean(nonsevere.hct)
m.nonsevere.platelets <- mean(nonsevere.platelets)
m.nonsevere.leukocytes <- mean(nonsevere.leukocytes)
m.nonsevere.ast <- mean(nonsevere.ast)
m.nonsevere.sbp <- mean(nonsevere.sbp)
m.nonsevere.alb <- mean(nonsevere.alb)
```

#### Standard deviations for non severe dengue variables

```{r nonseveredengueSDs}
sd.nonsevere.age <- sd(nonsevere.age)
sd.nonsevere.fever <- sd(nonsevere.fever)
sd.nonsevere.hgb <- sd(nonsevere.hgb)
sd.nonsevere.hct <- sd(nonsevere.hct)
sd.nonsevere.platelets <- sd(nonsevere.platelets)
sd.nonsevere.leukocytes <- sd(nonsevere.leukocytes)
sd.nonsevere.ast <- sd(nonsevere.ast)
sd.nonsevere.sbp <- sd(nonsevere.sbp)
sd.nonsevere.alb <- sd(nonsevere.alb)
```

### T Tests

Ok so far so good. My means and standard deviations are both matching with what the authors got in their Table 1. I will pull this together in my own table once I have completed the T Tests.

#### Variance Testing

First need to test for equal/unequal variance. If any of these are lower than 2, then I can use the equal variance argument in the t test.

```{r variance-tests}
var(nonsevere.age)/var(severe.age) #greater than 2
var(nonsevere.fever)/var(severe.fever) #less than 2
var(severe.hgb)/var(nonsevere.hgb) #technically less than 2 but really on the line!!
var(severe.hct)/var(nonsevere.hct) #greater than 2
var(nonsevere.platelets)/var(severe.platelets) #less than 2
var(severe.leukocytes)/var(nonsevere.leukocytes) #less than 2
var(severe.ast)/var(nonsevere.ast) #far greater than 2. I am not sure why this is so large, the individual elements going into it are not weird as far as I can tell
var(severe.sbp)/var(nonsevere.sbp) #less than 2
var(nonsevere.alb)/var(severe.alb) #less than 2
```

#### T-Testing!

Now I am performing unpaired two sample t tests. Variables with equal variances are indicated.

```{r t.tests}
t.age <- t.test(x = severe.age, y = nonsevere.age, mu = 0, alternative = "t"); t.age
t.fever <- t.test(x = severe.fever, y = nonsevere.fever, mu = 0, var.equal = TRUE, alternative = "t"); t.fever
t.hgb <- t.test(x = severe.hgb, y = nonsevere.hgb, mu = 0, var.equal = TRUE, alternative = "t"); t.hgb
t.hct <- t.test(x = severe.hct, y = nonsevere.hct, mu = 0, alternative = "t"); t.hct
t.platelets <- t.test(x = severe.platelets, y = nonsevere.platelets, mu = 0, var.equal = TRUE, alternative = "t"); t.platelets
t.leukocytes <- t.test(x = severe.leukocytes, y = nonsevere.leukocytes, mu = 0, var.equal = TRUE, alternative = "t"); t.leukocytes
t.ast <- t.test(x = severe.ast, y = nonsevere.ast, mu = 0, alternative = "t"); t.ast
t.sbp <- t.test(x = severe.sbp, y = nonsevere.sbp, mu = 0, var.equal = TRUE, alternative = "t"); t.sbp
t.alb <- t.test(x = severe.alb, y = nonsevere.alb, mu = 0, var.equal = TRUE, alternative = "t"); t.alb
```

#### Double Checking Work

Comparing to Table 1, most of my p-values are spot on. However, the ones that are not var.equal=TRUE do not match. These samples do not have equal variances thus they cannot have pooled standard deviation in the t test. Just to prove a point, below I am going to perform those t.tests (age, hematocrit, and AST) with var.equal=TRUE to see if the p-values match the ones in Table 1.

```{r fake-t.tests}
t.age.fake <- t.test(x = severe.age, y = nonsevere.age, mu = 0, var.equal = TRUE, alternative = "t"); t.age.fake
t.hct.fake <- t.test(x = severe.hct, y = nonsevere.hct, mu = 0, var.equal = TRUE, alternative = "t"); t.hct.fake
t.ast.fake <- t.test(x = severe.ast, y = nonsevere.ast, mu = 0, var.equal = TRUE, alternative = "t"); t.ast.fake
```

I suspect that the authors used an equal variance statistical test to derive their p values. Maybe they had some reason to do that, but it is not discussed in the paper. I do not think it is warranted, especially in the case of the AST which goes from not signifcant to highly significant **and** AST has the most variance in my variance test.

#### Building my Table

First I need to compile each column variable. These are the p values, the t statistic (not originally included in the paper but it is good practice to include them), the severe dengue means, the non severe dengue means, the severe dengue standard deviations, and the non severe dengue standard deviations. I also included a character vector for the names of the rows.

```{r columns}
library(pixiedust)
p.values <- c(t.age$p.value, t.fever$p.value, t.hgb$p.value, t.hct$p.value, t.platelets$p.value, t.leukocytes$p.value, t.ast$p.value, t.sbp$p.value, t.alb$p.value) %>% 
  pvalString(format = "default")
t_Scores <- c(t.age$statistic, t.fever$statistic, t.hgb$statistic, t.hct$statistic, t.platelets$statistic, t.leukocytes$statistic, t.ast$statistic, t.sbp$statistic, t.alb$statistic) %>% 
  round(digits = 2) #not included in original table but should be!
Severe_Means <- c(m.severe.age, m.severe.fever, m.severe.hgb, m.severe.hct, m.severe.platelets, m.severe.leukocytes, m.severe.ast, m.severe.sbp, m.severe.alb) %>% 
  round(digits = 2)
Severe_SDs <- c(sd.severe.age, sd.severe.fever, sd.severe.hgb, sd.severe.hct, sd.severe.platelets, sd.severe.leukocytes, sd.severe.ast, sd.severe.sbp, sd.severe.alb) %>% 
  round(digits = 2)
Non_Severe_Means <- c(m.nonsevere.age, m.nonsevere.fever, m.nonsevere.hgb, m.nonsevere.hct, m.nonsevere.platelets, m.nonsevere.leukocytes, m.nonsevere.ast, m.nonsevere.sbp, m.nonsevere.alb) %>% 
  round(digits = 2)
Non_Severe_SDs <- c(sd.nonsevere.age, sd.nonsevere.fever, sd.nonsevere.hgb, sd.nonsevere.hct, sd.nonsevere.platelets, sd.nonsevere.leukocytes, sd.nonsevere.ast, sd.nonsevere.sbp, sd.nonsevere.alb) %>% 
  round(digits = 2)
Parameters <- c("Age (years)", "Days of Fever before Admission", "Hemoglobin at Admission", "Hematocrit at Admission", "Platelets at Admission", "Total Leukocyte Count", "Asptartate Transaminase", "Percent Drop in Systolic BP", "Albumin")
```

After some playing around with the formatting of the table, I added rounding and formatting to each variable to clean it up. I was trying to do this after after column binding them into the table and it was not working very well because it would switch the class to character instead of numeric. I also found this package {pixiedust} which has a lot of functions to clean up and format tables. I was experimenting with these functions, but they did not have a row name function so ultimately I only used their built in p-value formatting function, which admittedly is incredibly convenient!

Next I column bind the column variables together and coerce it into a data frame. I named it newtable1 because this is my IMPROVED version of the paper's table 1. 

```{r create-table}
newtable1 <- data.frame(cbind(Severe_Means, Severe_SDs, Non_Severe_Means, Non_Severe_SDs, t_Scores, p.values))
newtable1
```

Note there are no row names yet and the column names are just the object names.

Finally, named the rows and columns.

```{r naming-rows}
rownames(newtable1) <- Parameters
colnames(newtable1) <- c(Severe_Means = "Severe Mean", Severe_SDs = "Severe SD", Non_Severe_Means = "Non-Severe Mean", Non_Severe_SDs = "Non-Severe SD", t_scores = "T Statistic", p.values = "p Values")
newtable1
```

I think this looks pretty good! But I think it could look even better. I found a package {gt} that makes pretty tables. 

## Multiple Logistic Regression

In a single logistic regression, Postural SBP is a very significant predictor of severe dengue.
```{r}
# glm of Severe Dengue ~ Postural Systolic BP Drop
glm <- glm(data = dengue, Severe_Dengue ~ Postural.SBP_Drop, family = "binomial")
summary(glm)
```
multiple logistic regression:
```{r}
dengue$Hct_Rise <- as.factor(dengue$Hct_Rise)  # making all of 1/0 columns factors
dengue$Ascite_Efusion <- as.factor(dengue$Ascite_Efusion)
dengue$Hepatomegaly <- as.factor(dengue$Hepatomegaly)
dengue$Lethargy <- as.factor(dengue$Lethargy)
dengue$Severe.Vomiting <- as.factor(dengue$Severe.Vomiting)
dengue$Severe.Abdominal.pain <- as.factor(dengue$Severe.Abdominal.pain)
dengue$Mucosal.Bleeding <- as.factor(dengue$Mucosal.Bleeding)
glm.dengue <- glm(data = dengue, formula = Severe_Dengue ~ Hct_Rise + Postural.SBP_Drop + Ascite_Efusion + Hepatomegaly + Lethargy + Severe.Vomiting + Severe.Abdominal.pain + Mucosal.Bleeding, family = binomial)
summary(glm.dengue)
```


## Odds ratios

An odds ratio is the odds of an outcome given an exposure compared to the lack of that exposure. An odds ratio greater than 1 means there is a associated odds of that outcome happening. An odds ratio less than 1 means there is a lower odds. An odds ratio equal to 1 does not affect the outcome. A wide CI indicates a low level of precision in the odds ratio. A narrow CI indicates high precision in the odds ratio. In the dengue case, Mahabala et al. would predict a high odds of postural fall in SBP associated with severe dengue, and therefore a high odds ratio (over 1). They might also expect the hematocrit to have a high odds ratio since it is also a proxy of capillary leak and therefore both are measurable manifestations of the same underlying symptom.

```{r}
coeffs <- glm.dengue$coefficients
coeffs
```